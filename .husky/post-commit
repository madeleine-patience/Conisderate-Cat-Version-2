#!/bin/sh

TEMP_FILE=".changelog_generated"

# Clean up the flag file on exit
trap 'rm -f "$TEMP_FILE"' EXIT

# Exit if the flag file exists
if [ -f "$TEMP_FILE" ]; then
  exit 0
fi

# Create the temporary flag file to prevent re-entry
touch "$TEMP_FILE"

# Remove the existing CHANGELOG.md
if [ -f "CHANGELOG.md" ]; then
  echo "Removing existing CHANGELOG.md..."
  rm CHANGELOG.md
fi

# Generate a fresh CHANGELOG.md
if ! npm run changelog; then
  echo "Failed to generate CHANGELOG.md. Aborting."
  exit 1
fi

# Add the new CHANGELOG.md to the commit
git add CHANGELOG.md
git commit --amend --no-edit